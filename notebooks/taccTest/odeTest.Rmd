---
title: "ODE benchmarking"
output: html_notebook
---

```{r}
library(cmdstanr)
set.seed(1302589023)
```

# Generate fake data

```{r}
make_states = function(n=500, tmin = 1E-3, tmax=48, a0=10, ke=0.2, noise_mean = 0, noise_scale=.1){
  ts = seq(tmin, tmax, length=n)
  noise = rnorm(n, noise_mean, noise_scale)
  a = a0 * exp(-ke*ts) + noise
  out = data.frame(ts=ts, a=a, noise=noise)
  return(out)
}
```

View fake data

```{r}
dat = make_states()
dat %>%
  ggplot(aes(ts, a))+
  geom_point()
```

# Fit models

Fit ODE model

```{r}
mod = cmdstan_model('./stanModels/odeTest2.stan')
```

```{r}
mod_dat = list(N = length(dat$a),
                ts = dat$ts,
                a = matrix(dat$a, ncol=1))
```

```{r}
fit = mod$sample(data = mod_dat)
fit$save_object(file = './stanModels/fit_odeTest2.RDS')
```

Fit analytical model

```{r}

```

#Examine output

True versus estimated y's for analytical solution:

```{r}
est_y = data.frame(ode_fit1$summary("states_rep"))

est_y %>%
  select(mean) %>%
  mutate(time = 1:n(),
         key = "est_y") %>%
  rename(value = mean) %>%
  rbind(data.frame(testStates) %>%
          select(y) %>%
          slice(-1) %>%
          mutate(time = 1:n(), 
                 key = "true_y") %>%
          rename(value = y)) %>%
  spread(key, value) %>%
  ggplot(aes(est_y, true_y))+
  geom_point()+
  geom_abline(aes(intercept=0, slope=1))
```

True versus estimated states for ODE solver:

```{r}

```
