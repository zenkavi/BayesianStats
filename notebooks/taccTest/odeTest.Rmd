---
title: "ODE benchmarking"
output: html_notebook
---

```{r}
library(cmdstanr)
set.seed(1302589023)
```

# Generate fake data

```{r}
make_states = function(n=500, tmin = 1E-3, tmax=48, a0=10, ke=0.2, noise_mean = 0, noise_scale=.1){
  ts = seq(tmin, tmax, length=n)
  noise = rnorm(n, noise_mean, noise_scale)
  a = a0 * exp(-ke*ts) + noise
  out = data.frame(ts=ts, a=a, noise=noise)
  return(out)
}
```

View fake data

```{r}
dat = make_states()
dat %>%
  ggplot(aes(ts, a))+
  geom_point()
```
Set up data for Stan models

```{r}
mod_dat = list(N = length(dat$a),
                ts = dat$ts,
                a = matrix(dat$a, ncol=1))
```

# Fit models

Fit analytical model

```{r}
mod1 = cmdstan_model('./stanModels/odeTest1.stan')
```

```{r}
fit1 = mod1$sample(data = mod_dat)
fit1$save_object(file = './stanModels/fit_odeTest1.RDS')
```

Fit ODE model

```{r}
mod2 = cmdstan_model('./stanModels/odeTest2.stan')
```

```{r}
fit2 = mod2$sample(data = mod_dat)
fit2$save_object(file = './stanModels/fit_odeTest2.RDS')
```

# Examine output

## Analytical solution

```{r}
fit1
```

## ODE solver

```{r}
fit2
```

True versus estimated states for ODE solver:

```{r}

```
