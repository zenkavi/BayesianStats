---
title: "Neural mass model simulation and parameter recovery with Stan"
---

```{r}
library(tidygraph)
library(ggraph)
```

Suppose we have a three node network that looks like:

```{r}
edges = data.frame(from = c(1, 1, 2, 2, 3), to = c(2, 3, 1, 3, 2), weight = c(.4, .4, .2, .3, .2))
nodes = data.frame(id = c(1,2,3), label = c("1", "2", "3"))
```

```{r}
min_net = tbl_graph(nodes=nodes, edges=edges, directed=T)
min_net
```

```{r}
ggraph(min_net, layout="tree")+
  geom_edge_parallel(aes(width=weight, label=weight), 
                 alpha=.8,
                 arrow = arrow(length = unit(4, 'mm')),
                 end_cap = circle(5, 'mm'),
                 start_cap = circle(5, 'mm'),
                 label_dodge=unit(-4.0,"mm"),
                 # label_push=unit(4,"mm"),
                 position="identity",angle_calc="along",force_flip=T)+
  scale_edge_width(range=c(.2,2))+
  geom_node_point(size=7)+
  geom_node_label(aes(label=label), 
                 repel=T, 
                 nudge_y = .1)+
  theme_graph()+
  theme(legend.position = "none",
        plot.margin = margin(-.5, 1, .5, 1, "cm"))
```
Adjacency matrix for the above minimal network looks like:

```{r}
W<-matrix(0, 3, 3)
W[as.matrix(edges[,1:2])] <- edges$weight
W
```

```{r}
edges %>%
  rbind(data.frame(from = c(1,2,3,3), to = c(1,2,3,1), weight = c(0,0,0,0))) %>%
  ggplot(aes(x=to, y=from, fill=weight))+
  geom_tile()
```

Suppose we have a task that looks like:

```{r}
task = data.frame(time = rep(1:15), stim = c(0,0,0,1,1,1,0,0,0,1,1,1,0,0,0))
task %>%
  ggplot(aes(x=time, y=stim))+
  geom_line()+
  xlab("")+
  ylab("")+
  scale_x_continuous(breaks = seq(1,15,1))+
  scale_y_continuous(breaks = c(0,1))
```

The task stimulates *only* node 1 directly and propagates within the network based on the following Eq:

$$\frac{dx_i}{dt}\tau_i = -x_i(t) + s\phi\big(x_i(t)\big) + g\Bigg(\sum_{j\neq i}^{N} W_{ij}\phi\big(x_j(t)\big)\Bigg) + I_i(t)$$
Activity in each node at each time point would look like:

```{r}
default_args_dict$Tmax = max(task$time)
default_args_dict$I = matrix(c(task$stim, rep(0, max(task$time)), rep(0, max(task$time))), 
                             nrow(nodes), max(task$time), byrow=TRUE)
networkModel(W, default_args_dict)
```

------

Question re estimation methods: Are the posteriors unimodal in VI vs MCMC? Are we losing important information when making assumptions like the Laplace approximation?
